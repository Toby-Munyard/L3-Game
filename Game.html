<!doctype html>

<head>
    <title>Star Jumper</title>
    <link rel="shortcut icon" href="images/StarSprite.png">
    <script src="player.js"></script>
    <script src="enemy.js"></script>
    <script src="platform.js"></script>
</head>

<body>
    <canvas id="gameCanvas" width="1000" height="600"></canvas>
    <script>
        var canvas, canvasContext, imageAssests;

        window.onload = function () {
            canvas = document.getElementById('gameCanvas');
            canvasContext = canvas.getContext('2d');
            imageAssests = loadImgAssests();

            document.addEventListener('keydown', keyPressed);
            document.addEventListener('keyup', keyReleased);

            setInterval(mainloop, 1000 / 50);
        }

        //game variables
        var gameRun = true;
        var gameWin = false;
        var stageNumber = 1;
        var health = 3;
        var score = 0;
        var touchingPlatform = false;
        var Background1 = new Image();
        Background1.src = 'images/Background.png';
        var Background2 = new Image();
        Background2.src = 'images/Background2.png';
        var Background3 = new Image();
        Background3.src = 'images/Background3.jpg';
        var Background4 = new Image();
        Background4.src = 'images/Background4.png';
        var Background5 = new Image();
        Background5.src = 'images/Background5.jpg';
        var Stage1Bottom = new Image();
        Stage1Bottom.src = 'images/Stage1Bottom.png';
        var Stage2Bottom = new Image();
        Stage2Bottom.src = 'images/Stage2Bottom.png';
        var Stage3Bottom = new Image();
        Stage3Bottom.src = 'images/Stage3Bottom.png';
        var Stage4Bottom = new Image();
        Stage4Bottom.src = 'images/Stage4Bottom.png';
        var Stage5Bottom = new Image();
        Stage5Bottom.src = 'images/Stage5Bottom.png';

        //bottom of game
        var bXpos = 0;
        var bYpos = 520;

        //background variables
        var BackgroundWidth = 1000;
        var BackgroundHeight = 600;

        //player vars
        var pXpos = 0;
        var pYpos = 0;
        var pXSpeed = 5;
        var pYSpeed = 5;
        const P_SIZE = 20;
        var pSPRITE = new Image();
        pSPRITE.source = 'images/SpriteSheet.png';

        //enemy vars
        var enemies = [];
        var setUp = true;
        var totalEnemies = 5;
        var enemyCounter = 0;
        // var eXpos = 200;
        // var eYpos = 300;
        // var eXSpeed = 5;
        // var eYSpeed = 5;
        // const E_SIZE = 20;

        //movement vars
        var leftKeyPressed = false;
        var upKeyPressed = false;
        var rightKeyPressed = false;
        var downKeyPressed = false;
        var spaceKeyPressed = false;

        //movement constants
        const LEFT_KEY = 37;
        const UP_KEY = 38;
        const RIGHT_KEY = 39;
        const DOWN_KEY = 40;
        const SPACE_KEY = 32;

        //platfrom vars
        var platforms = [];
        var totalPlatforms = 5;
        var platformCounter = 0;
        // var PlatformXPos = 500;
        // var PlatformYPos = 300;
        // var PlatformXWidth = 100;
        // var PlatformYHeight = 200;

        var player = new
        Player(pXpos, pYpos, P_SIZE, P_SIZE, 'green', pXSpeed, pYSpeed);

        var userName = '';

        while (userName == '' || userName == null) {
            userName = prompt('what is your name?');
        };

        var difficulty = 'easy';
        var pass = false;

        while (pass == false) {
            difficulty = prompt('What difficulty do you want? easy, medium or hard?', 'easy');
            difficulty = difficulty.toLowerCase(); //forces capitals to be lower case
            if (difficulty == 'easy' || difficulty == 'medium' || difficulty == 'hard') {
                pass = true;
            }
            if (difficulty == 'easy') {
                enemyCounter = 15;
                min = 2;
                max = 6;
            }
            if (difficulty == 'medium') {
                enemyCounter = 12;
                min = 6;
                max = 10;
            }
            if (difficulty == 'hard') {
                enemyCounter = 10;
                min = 10;
                max = 12;
            }
        };

        function drawImg(src, x, y, w, h) {
            canvasContext.drawImage(src, x, y, w, h);
        }; // end func this is how images are imported

        function loadImgAssests() {
            imgs = {};

            imgs.coin = new Image();
            imgs.coin.src = 'images/coinSpriteSheet.png'

            return imgs;
        }// end func holds information relating to sprite animations

        function drawSprite(img, sX, sY, sW, sH, dX, dY, dW, dH) {
            canvasContext.drawImage(img, sX, sY, sW, sH, dX, dY, dW, dH);
        }// end func this is how sprites are imported

        // function enemyMove() {

        //     enemy.y += enemy.ySpeed;

        //     if (enemy.y > canvas.height) { // enemy out of bottom of canvas 
        //         enemy.y = 0 - enemy.w * enemy.h;
        //         enemy.x = Math.floor(Math.random() * (canvas.width - enemy.w * enemy.h));
        //         enemy.ySpeed = Math.floor(Math.random() * (12 - 4) + 4);
        //     }

        //     if (enemy.y + E_SIZE > player.y && enemy.y < player.y + P_SIZE && enemy.x + E_SIZE > player.x && enemy.x <
        //         player.x + P_SIZE) {
        //         // player respawns to center of canvas after enemy collides with player
        //         enemy.x = Math.floor(Math.random() * (canvas.width - E_SIZE));
        //         enemy.y = canvas.height + 100;
        //         player.x = 0;
        //         player.y = canvas.height - 100;
        //         health--;
        //         console.log('Health:' + health);
        //     }
        // } //end func moves enemies and respawns them at the top after they hit the player

        function makeEnemy() {
            var ePos = Math.floor(Math.random() * 7) + 1;
            const E_SIZE = 20;
            const gap = 30;
            var eXpos = enemyCounter * E_SIZE + gap * enemyCounter;
            var eYpos = 0 - E_SIZE;
            var eXspeed = Math.floor(Math.random() * (max - min) + max);
            var eYspeed = Math.floor(Math.random() * (max - min) + max);

            enemyCounter++

            var enemy = new
            Enemy(eXpos, eYpos, E_SIZE, E_SIZE, 'white', eXspeed, eYspeed);

            enemies.push(enemy);
        } // end func makes enemies spawn at random positions, speeds etc. lower player 'health' when hit

        function makePlatform() {
            var platformPos = Math.floor(Math.random() * 7) + 1;
            const PLATFORM_SIZE = 20;
            const platformGap = 30;
            var platformXpos = enemyCounter * PLATFORM_SIZE + platformGap * platformCounter;
            var platformYpos = Math.floor(Math.random() * (500 - 10) + max);

            platformCounter++

            var platform = new
        Platform(platformXpos, platformYpos, PLATFORM_SIZE, PLATFORM_SIZE, 'red');

            platforms.push(platform);
        }; // end func makes pickups for the player to pick up which increase 'score'

        // function PlatformCollision() {
        //     if (platform.y + PlatformYHeight > player.y && platform.y < player.y + P_SIZE && platform.x +
        //         PlatformXWidth > player.x && platform.x < player.x + P_SIZE) {
        //         // player stops moving if touching platform 
        //         touchingPlatform = true;
        //         player.y = platform.y - P_SIZE;
        //         player.x = platform.x - P_SIZE;
        //         console.log('collision')
        //     }
        // }

        function playerStop() {
            if (touchingPlatform) {
                player.ySpeed = 0;
                console.log('stop')
            }
        }; // end func stops the player from moving when touching a platform

        function bottomCollision() {
            if (player.y >= bYpos - 20) {
                player.y = bYpos - 20;
                console.log('HES GONE')
            }
        }; // end func stops the player from falling out of the bottom of the canvas

        function NewLevel() {
            if (player.x >= canvas.width) {
                stageNumber++;
                console.log('Stage: ' + stageNumber)
                return makePlatform();
            }
        }; //end func changes the stageHumber each time the player reaches the far right of the canvas which allows the changeStyle function to then change the background

        function changeStyle() {
            if (stageNumber == 1) {
                drawImg(Background1, 0, 0, canvas.width, canvas.height);
                drawImg(Stage1Bottom, bXpos, bYpos, canvas.width, 80);
            }
            if (stageNumber == 2) {
                drawImg(Background2, 0, 0, canvas.width, canvas.height);
                drawImg(Stage2Bottom, bXpos, bYpos, canvas.width, 80);
            }
            if (stageNumber == 3) {
                drawImg(Background3, 0, 0, canvas.width, canvas.height);
                drawImg(Stage3Bottom, bXpos, bYpos, canvas.width, 80);
            }
            if (stageNumber == 4) {
                drawImg(Background4, 0, 0, canvas.width, canvas.height);
                drawImg(Stage4Bottom, bXpos, bYpos, canvas.width, 80);
            }
            if (stageNumber == 5) {
                drawImg(Background5, 0, 0, canvas.width, canvas.height);
                drawImg(Stage5Bottom, bXpos, bYpos, canvas.width, 80);
            }
        }; // end func changes the bottom and background of the canvas depending on the stage number

        function GameEnd() {
            if (health <= 0) {
                gameRun = false;
            }
            if (stageNumber >= 6) {
                gameWin = true;
            }
        }; // end func detects when health is below 0 or stageNumber is above or equal to 6 and ends the game accordingly

        function keyPressed(evt) {
            if (evt.keyCode == LEFT_KEY) {
                leftKeyPressed = true;
            }
            if (evt.keyCode == UP_KEY) {
                upKeyPressed = true;
            }
            if (evt.keyCode == RIGHT_KEY) {
                rightKeyPressed = true;
            }
            if (evt.keyCode == DOWN_KEY) {
                downKeyPressed = true;
            }
            if (evt.keyCode == SPACE_KEY) {
                spaceKeyPressed = true;
            }
        }; // end func detects key being pressed

        function keyReleased(evt) {
            if (evt.keyCode == LEFT_KEY) {
                leftKeyPressed = false;
            }
            if (evt.keyCode == UP_KEY) {
                upKeyPressed = false;
            }
            if (evt.keyCode == RIGHT_KEY) {
                rightKeyPressed = false;
            }
            if (evt.keyCode == DOWN_KEY) {
                downKeyPressed = false;
            }
            if (evt.keyCode == SPACE_KEY) {
                spaceKeyPressed = false;
            }
        }; //end func detects key press being released

        function mainloop() {
            if (gameRun) {
                // drawSprite(imageAssests.coin, platforms.platformXpos, platforms.platformYpos, platforms.PLATFORM_SIZE, platforms.PLATFORM_SIZE, 42, 43, 45, 47);
                // drawImg(Background1, 0, 0, BackgroundWidth, BackgroundHeight,); //background
                // drawImg(Stage1Bottom, bXpos, bYpos, canvas.width, 80); //ground
                // colorRect(PlatformXPos, PlatformYPos, PlatformXWidth, PlatformYHeight, 'brown') //Platform
                // colorRect(eXpos, eYpos, E_SIZE, E_SIZE, 'white'); //enemy
                // colorRect(pXpos,pYpos,P_SIZE,P_SIZE,'white'); //player

                if (setUp) {
                    for (i = 0; i < totalEnemies; i++) {
                        makeEnemy();
                    }
                    for (i = 0; i < totalPlatforms; i++) {
                        makePlatform();
                    }
                    setUp = false;
                };

               
                player.move();
                player.collide();
                playerStop();
                GameEnd();
                bottomCollision();
                playerStop();
                NewLevel();
                changeStyle();
                player.draw();
                enemies.push();
                makeEnemy();
                makePlatform();
                colorText(userName + " is on stage " + stageNumber, 15, 20, '20px Arial', 'Lime')
                colorText(userName + "'s health is " + health, 15, 40, '20px Arial', 'Lime')
                colorText('Run to the right! Arrow Keys to move! Dodge Those Enemies!', 15, 60, '20px Arial', 'Lime')
                drawSprite(imageAssests.coin, 0, 0, 445, 447, 250, 250, 100, 100);

                if (enemies.length > 0) {
                    enemies.forEach(function (enemy, i) {
                        enemy.draw();
                        enemy.move();
                        enemy.hit();

                        if(enemy.outOfBounds() || enemy.hasCollided){
                            // enemy.y = 0 - enemy.E_SIZE;
                        }
                    });
                }

                if (platforms.length > 0) {
                    platforms.forEach(function (platform, i) {
                        platform.draw();
                        platform.hit();
                    });
                }

            } else {
                colorRect(0, 0, BackgroundWidth, BackgroundHeight, 'black'); //background
                colorText('Game Over!', 50, 50, '20px Arial', 'red'); //game over text
                colorText(userName + ' you made it to stage ' + stageNumber, 50, 80, '20px Arial', 'red');
                colorText('You lost with a score of ' + score, 50, 110, '20px Arial', 'red');
                colorText('Click the reload page button to try and win!', 50, 140, '20px Arial', 'red');
            };
            if (gameWin) {
                colorRect(0, 0, BackgroundWidth, BackgroundHeight, 'black'); //background
                colorText('CONGRATULATIONS ' + userName + ' YOU WIN!', 50, 50, '20px Arial', 'green'); //game over text
                colorText(userName + ' you made it through every stage!', 50, 80, '20px Arial', 'green');
                colorText('You finished with a score of ' + score, 50, 110, '20px Arial', 'green');
                colorText('Click the reload page button to play again!', 50, 140, '20px Arial', 'green');
            };

        }; // end func mainloop contains and runs all other functions in the code

        function colorText(msg, x, y, f, c) {
            canvasContext.fillStyle = c;
            canvasContext.font = f;
            canvasContext.fillText(msg, x, y);
        }; // end func draws text for the canvas

        function colorRect(x, y, w, h, c) {
            canvasContext.fillStyle = c;
            canvasContext.fillRect(x, y, w, h);
        } //end func defines the basic outline of the screen
    </script>
</body>